name: smoke-tests-bare-metal

on:
  push:
    branches:
      - 'smoke-tests'

env:
  BUILD_TYPE: 'Release'
  DPDK_VERSION: '23.11'
  DPDK_REBUILD: 'false'

permissions:
  contents: read

jobs:
  validation-build-mcm:
    runs-on: [Linux, self-hosted, DPDK]
    timeout-minutes: 60
    outputs:
      pipenv-activate: ${{ steps.pipenv-install.outputs.VIRTUAL_ENV }}
    steps:
      - name: 'preparation: Harden Runner'
        uses: step-security/harden-runner@6c439dc8bdf85cadbbce9ed30d1c7b959517bc49 # v2.12.2
        with:
          egress-policy: audit

      - name: 'preparation: Restore valid repository owner and print env'
        if: always()
        run: |
          sudo chown -R "${USER}" "$(pwd)" || true
          env | grep BUILD_ || true
          env | grep DPDK_ || true
      - name: 'preparation: Generate and configure SSH keys'
        run: |
          # Create .ssh directory
          sudo mkdir -p /home/"${USER}"/.ssh
          
          # Generate new SSH key pair directly in the target location
          sudo ssh-keygen -t rsa -N "" -f /home/"${USER}"/.ssh/mcm_key
          
          # Copy public key to authorized_keys
          sudo cp /home/"${USER}"/.ssh/mcm_key.pub /home/"${USER}"/.ssh/authorized_keys
          
          # Set proper permissions
          sudo chmod 600 /home/"${USER}"/.ssh/mcm_key
          sudo chmod 644 /home/"${USER}"/.ssh/mcm_key.pub
          sudo chmod 600 /home/"${USER}"/.ssh/authorized_keys
          sudo chmod 700 /home/"${USER}"/.ssh
          sudo chown -R "${USER}":"${USER}" /home/"${USER}"/.ssh
          
          # Add localhost to known_hosts to avoid prompts
          sudo -u "${USER}" ssh-keyscan -H localhost >> /home/"${USER}"/.ssh/known_hosts
      - name: 'preparation: Checkout MCM'
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: 'smoke-tests'
      - name: 'installation: Install pipenv environment'
        working-directory: tests/validation
        id: pipenv-install
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          echo "VIRTUAL_ENV=$PWD/venv/bin/activate" >> "$GITHUB_ENV"
      - name: 'add user name to environment and config'
        run: |
          echo "USER=${USER}" >> "$GITHUB_ENV"
          sed -i "s/{{ USER }}/${USER}/g" tests/validation/configs/topology_config_workflow.yaml
          sed -i "s|{{ KEY_PATH }}|/home/${USER}/.ssh/mcm_key|g" tests/validation/configs/topology_config_workflow.yaml
  validation-run-tests:
    needs: validation-build-mcm
    runs-on: [Linux, self-hosted, DPDK]
    timeout-minutes: 60
    env:
      PYTEST_RETRIES: '3'
    steps:
      - name: 'preparation: Kill pytest routines'
        run: |
          sudo killall -SIGINT pipenv || true
          sudo killall -SIGINT pytest || true
      - name: 'list all smoke tests'
        run: |
          sudo tests/validation/venv/bin/python3 -m pytest \
            --collect-only --quiet ./tests/validation/functional/ -m smoke
      - name: 'execution: Run validation-bare-metal tests in virtual environment'
        run: |
          sudo tests/validation/venv/bin/python3 -m pytest \
            --topology_config=tests/validation/configs/topology_config_workflow.yaml \
            --test_config=tests/validation/configs/test_config_workflow.yaml -m smoke \
            ./tests/validation/functional/ \
            --template=html/index.html --report=report.html